# vim:ft=nginx

server {
  listen 30666;
  server_name <%= Yeb::Hostname::TLD_WILDCARDS %>;

  if ($host ~* "\.*([^.]+)\.(<%= Yeb::Hostname::TLD_REGEXP.source %>)$") {
    set $app_name $1;
  }

  root <%= APPS_DIR %>/$app_name/public;

  try_files /system/maintenance.html $uri/index.html $uri.html $uri @app;

  # charset koi8-r;

  access_log logs/$app_name.access.log;

  if ($host ~* "^(.*)\.(<%= Yeb::Hostname::TLD_REGEXP.source %>)$") {
    set $socket_name $1;
  }

  location @app {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_pass http://unix:<%= SOCKETS_DIR %>/$socket_name.sock;
    error_page 502 = @spawner;
  }

  location @spawner {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_pass http://unix:<%= SERVER_SOCKET_PATH %>;
  }

  error_page 404 /404.html;
}
